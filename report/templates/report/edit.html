<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Daily</title>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="http://cdn.bootcss.com/blueimp-md5/1.1.0/js/md5.js"></script>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>

<nav class="navbar navbar-default" role="navigation" style="background: #0593D3">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" style="color: aliceblue;font-size: 23px;font-weight: bold">日报统计工具</a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li style="background: #0482BA"><a href="edit" style="color: aliceblue;font-size: 20px">编辑日报</a></li>
                <li id="statistics" style="display: none"><a href="statistics" style="color: aliceblue;font-size: 18px">统计日报</a>
                </li>
                <li id="settings" style="display: none"><a href="settings"
                                                           style="color: aliceblue;font-size: 18px">设置</a></li>
                <li id="search"><a href="search" style="color: aliceblue;font-size: 18px">搜索</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <p id="show_name" class="navbar-text" style="color: aliceblue;font-size: 15px"></p>
                <li><a href="#" onclick="logout()" style="color: aliceblue;font-size: 18px"><span
                        class="glyphicon glyphicon-log-out"></span> 登出</a></li>
            </ul>
        </div>
    </div>
</nav>


<style type="text/css">
    .AutoNewline {
        Word-break: break-all;
    }
</style>

<style>
    table {

    }

    th {
        height: 30px;
        font-size: 16px;
        background-color: #D9EDF7;
        padding: 3px;
    }

    td {
        height: 60px;
        font-size: 18px;
        padding: 3px;
    }
</style>


<div style="padding: 20px">
{#    <h4>前三天：</h4>#}
{#    <table class="AutoNewline" id="last" border="1" cellpadding="10">#}
{#        <tr>#}
{#            <th style="width: 120px;text-align: center">项目</th>#}
{#            <th style="width: 120px;text-align: center">工作类型</th>#}
{#            <th style="width: 100px;text-align: center">Bug ID</th>#}
{#            <th style="width: 350px;text-align: center">简要描述</th>#}
{#            <th style="width: 50px;text-align: center">优先级</th>#}
{#            <th style="width: 80px;text-align: center">是否reopen</th>#}
{#            <th style="width: 200px;text-align: center">reopen原因</th>#}
{#            <th style="width: 100px;text-align: center">解决方案</th>#}
{#            <th style="width: 100px;text-align: center">原因</th>#}
{#            <th style="width: 50px;text-align: center">责任人</th>#}
{#            <th style="width: 100px;text-align: center">日期</th>#}
{#            <th style="width: 350px;text-align: center">备注</th>#}
{#        </tr>#}
{#    </table>#}
{#    <br>#}
    <h4 id="today_title"></h4>
    <table class="AutoNewline" id="today" border="1" cellpadding="3" cellspacing="0">
        <tr>
            <th style="width: 120px;text-align: center">项目</th>
            <th style="width: 100px;text-align: center">工作类型</th>
            <th style="width: 100px;text-align: center">Bug ID</th>
            <th style="width: 430px;text-align: center">简要描述</th>
            <th style="width: 50px;text-align: center">优先级</th>
            <th style="width: 100px;text-align: center">是否reopen</th>
            <th style="width: 200px;text-align: center">reopen原因</th>
            <th style="width: 100px;text-align: center">解决方案</th>
            <th style="width: 100px;text-align: center">原因</th>
{#            <th style="width: 50px;text-align: center">责任人</th>#}
{#            <th style="width: 100px;text-align: center">日期</th>#}
            <th style="width: 350px;text-align: center">备注</th>
            <th></th>
        </tr>
        <tr id="content_0" style="height: 100px">
            <td>
                <select id="project">
                    <option></option>
                </select>
            </td>
            <td>
                <select id="work_type">
                    <option>解决bug</option>
                    <option>非bug库问题处理</option>
                    <option>基线升级</option>
                    <option>需求分析实现</option>
                    <option>团队建设</option>
                    <option>项目支持</option>
                    <option>SPM工作</option>
                    <option>请假</option>
                </select>
            </td>
            <td>
                <textarea id="bugid" style="width: 100px;height: 100%"></textarea>
            </td>
            <td>
                <textarea id="describe" style="width: 430px;height: 100%"></textarea>
            </td>
            <td>
                <select id="priority" style="width: 60px;">
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                </select>
            </td>
            <td>
                <select id="reopen" style="width: 80px">
                    <option></option>
                    <option>是</option>
                    <option>否</option>
                </select>
            </td>
            <td>
                <textarea id="reopen_reason" style="width: 210px;height: 100%"></textarea>
            </td>
            <td>
                <select id="solution">
                    <option></option>
                    <option>入库</option>
                    <option>转其他组</option>
                    <option>非问题</option>
                    <option>是问题不修改</option>
                    <option>重复</option>
                    <option>不复现关闭</option>
                    <option>输出文档</option>
                </select>
            </td>
            <td>
                <select id="solution_reason" style="width: 100px">
                    <option></option>
                    <option>原始问题</option>
                    <option>转其他组</option>
                    <option>修改引入</option>
                    <option>新需求</option>
                    <option>需求遗留问题</option>
                    <option>非问题</option>
                </select>
            </td>
{#            <td>#}
{#                <input id="person" style="width: 50px" readonly="true"/>#}
{#            </td>#}
{#            <td>#}
{#                <input id="date" style="width: 100px" readonly="true"/>#}
{#            </td>#}
            <td>
                <textarea id="remake" style="width: 100%;height: 100%"></textarea>
            </td>
            <td>
                <button id="delete_item" type="button" class="btn btn-danger"
                       onclick="delete_item(this.parentElement.parentElement.id)">删除</button>
            </td>
        </tr>
    </table><br><br>
    <button id="insert" class="btn btn-success" type="button" onclick="insert()">插入一行</button>
    <button id="submit" class="btn btn-primary" type="button" onclick="submit_info()">保存日报</button>
</div>

{#<script src="../../static/report/edit.js"></script>#}
<script>
    // 禁止后退到登录界面，退出登录只能通过“登出用户”按钮
    history.pushState(null, null, document.URL);
    window.addEventListener('popstate', function () {
        history.pushState(null, null, document.URL);
    });

    var i = 1;
    var old = {
        id: [],
        content_id: [],
        data: []
    };

    try {
        var user = document.cookie.match(/(^| )user=([^;]*)(;|$)/)[2].replace('"', '').replace('"', '');
        var team = document.cookie.match(/(^| )team=([^;]*)(;|$)/)[2].replace('"', '').replace('"', '');
        document.getElementById("show_name").innerText = user;
    } catch (e) {
        alert("请先登录!");
        window.location.href = 'login';
    }
    var submit_btn = document.getElementById('submit');
{#    document.getElementById("date").value = getNowFormatDate();#}

    var today_date = getNowFormatDate();



    var backup = document.getElementById("content_0");

    $.get('get_projects', {"team": team}, function (ret) {
        var projects = document.getElementById("project");
        for (let i = 0; i < ret.length; i++) {
            var y = document.createElement('option');
            y.text = ret[i].name;
            projects.add(y, null);
        }
        get_current_name();
    });

    function get_current_name() {
        $.get('get_current_name', {"user": user}, function (ret) {
{#            document.getElementById("person").value = ret["name"];#}
            document.getElementById("today_title").innerText = "当前： " +ret["name"]+ "\n 今日： "+today_date;
            var today = ret['today'];
            var past = ret['past'];

            if (past != "") {
{#                show_last(past);#}
            }
            if (ret["permission"]) {
                document.getElementById("statistics").style.display = "";
                document.getElementById("settings").style.display = "";
            }
            if (today != "") {
                submit_btn.value = "提交修改";
                for (var j = 0; j < today.length; j++) {
                    old.id.push(today[j]['id']);
                    if (j !== 0) {
                        // 第一行不需要插入
                        insert();
                    }
                    show_today(document.getElementById('content_' + j.toString()).children, today[j]);
                }
                var result = collect_cells(document.getElementById("today"));
                old.data = result.data;
                old.content_id = result.content_id;
            }
        });
    }


    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        return year + seperator1 + month + seperator1 + strDate;
    }

    function show_today(ch, today) {
        for (var i = 0; i < ch[0].childNodes[1].children.length; i++) {
            if (ch[0].childNodes[1].children[i].innerText === today['project']) {
                ch[0].childNodes[1].children[i].selected = true;
            }
        }

        for (var j = 0; j < ch[1].childNodes[1].children.length; j++) {
            if (ch[1].childNodes[1].children[j].innerText === today['work_type']) {
                ch[1].childNodes[1].children[j].selected = true;
            }
        }

        ch[2].childNodes[1].value = today['bugid'];
        ch[3].childNodes[1].value = today['describe'];
        for (let i = 0; i < ch[4].childNodes[1].children.length; i++) {
            if (ch[4].childNodes[1].children[i].innerText === today['priority']) {
                ch[4].childNodes[1].children[i].selected = true;
            }
        }
        for (let i = 0; i < ch[5].childNodes[1].children.length; i++) {
            if (ch[5].childNodes[1].children[i].innerText === today['reopen']) {
                ch[5].childNodes[1].children[i].selected = true;
            }
        }
        ch[6].childNodes[1].value = today['reopen_reason'];
        for (let i = 0; i < ch[7].childNodes[1].children.length; i++) {
            if (ch[7].childNodes[1].children[i].innerText === today['solution']) {
                ch[7].childNodes[1].children[i].selected = true;
            }
        }
        for (let i = 0; i < ch[8].childNodes[1].children.length; i++) {
            if (ch[8].childNodes[1].children[i].innerText === today['solution_reason']) {
                ch[8].childNodes[1].children[i].selected = true;
            }
        }
{#        ch[9].childNodes[1].value = today['person'];#}
{#        ch[10].childNodes[1].value = today['date'];#}
        ch[9].childNodes[1].value = today['remake'];
    }

    function show_last(ret) {
        var last = document.getElementById("last");
        var today = document.getElementById("today");
        for (var i = 0; i < ret.length; i++) {
            var line = document.createElement("tr");
            var cell_project = document.createElement("td");
            var cell_work_type = document.createElement("td");
            var cell_bugid = document.createElement("td");
            var cell_describe = document.createElement("td");
            var cell_priority = document.createElement("td");
            var cell_reopen = document.createElement("td");
            var cell_reopen_reason = document.createElement("td");
            var cell_solution = document.createElement("td");
            var cell_solution_reason = document.createElement("td");
            var cell_person = document.createElement("td");
            var cell_date = document.createElement("td");
            var cell_remake = document.createElement("td");
            cell_project.innerText = ret[i].project;
            cell_work_type.innerText = ret[i].work_type;
            cell_bugid.innerText = ret[i].bugid;
            cell_describe.innerText = ret[i].describe;
            cell_priority.innerText = ret[i].priority;
            cell_reopen.innerText = ret[i].reopen;
            cell_reopen_reason.innerText = ret[i].reopen_reason;
            cell_solution.innerText = ret[i].solution;
            cell_solution_reason.innerText = ret[i].solution_reason;
            cell_person.innerText = ret[i].person;
            cell_date.innerText = ret[i].date;
            cell_remake.innerText = ret[i].remake;
            line.appendChild(cell_project);
            line.appendChild(cell_work_type);
            line.appendChild(cell_bugid);
            line.appendChild(cell_describe);
            line.appendChild(cell_priority);
            line.appendChild(cell_reopen);
            line.appendChild(cell_reopen_reason);
            line.appendChild(cell_solution);
            line.appendChild(cell_solution_reason);
            line.appendChild(cell_person);
            line.appendChild(cell_date);
            line.appendChild(cell_remake);
            last.appendChild(line);
        }
    }

    function insert() {
        if (!document.getElementById("content_0")) {
            var parent = document.getElementById("today");
            parent.appendChild(backup);
        } else {
            var new_node = document.getElementById("content_0").cloneNode(true);
            new_node.id = "content_" + i.toString();
            today.appendChild(new_node);
            i++;
        }
    }

    function submit_info() {
        // 获取填写的信息
        var new_info = collect_cells(document.getElementById("today"));

        var post_data = {
            modify: {
                id: [],
                data: []
            },
            insert: [],
            del: []
        };

        // 档没有获取到当日日报内容时，第一次添加日报
        if (old.id.length === 0) {
            post_data.insert = new_info.data;
            send_daily(post_data);
            return
        }

        // 对当日日报内容进行了修改
        for (let i = 0; i < old.id.length; i++) {
            if (contains(new_info.content_id, old.content_id[i])) {
                let j = new_info.content_id.indexOf(old.content_id[i]);
                if (!compare(old.data[i], new_info.data[j])) {
                    // modify
                    post_data.modify.id.push(old.id[i]);
                    post_data.modify.data.push(new_info.data[j]);
                    console.log("modify " + new_info.data[j]);
                }
            } else {
                // delete
                post_data.del.push(old.id[i]);
                console.log("delete " + old.content_id[i])
            }
        }

        for (let i = 0; i < new_info.content_id.length; i++) {
            if (!contains(old.content_id, new_info.content_id[i])) {
                // insert
                console.log(new_info.data[i]);
                post_data.insert.push(new_info.data[i]);
                console.log("insert" + new_info.data[i]);
            }
        }

        if (post_data.insert.length === 0 && post_data.del.length === 0 && post_data.modify.id.length === 0) {
            alert("内容无修改，提交失败！");
            return
        }
        send_daily(post_data);
    }

    function send_daily(data) {
        $.post("send_daily", {"user": user, "data": JSON.stringify(data)}, function (ret) {
            if (Number(ret) === 0) {
                if (submit_btn.value === "提交日报") {
                    alert("提交日报成功！");
                    window.location.reload();
                } else {
                    alert("修改成功！");
                    window.location.reload();
                }
            } else {
                if (submit_btn.value === "提交日报") {
                    alert("提交日报失败！");
                } else {
                    alert("修改失败！");
                }
            }
        });
    }

    function statistics() {
        window.location.href = "statistics";
    }

    function search() {
        window.location.href = "search";
    }

    function delete_item(id) {
        var self = document.getElementById(id);
        var parent = self.parentElement;
        parent.removeChild(self);
        console.log(parent.childElementCount);
    }

    function collect_cells(table) {
        var result = {
            content_id: [],
            data: []
        };
        for (var i = 1, rows = table.rows.length; i < rows; i++) {
            result.content_id.push(table.rows[i].id);
            for (var j = 0, cells = table.rows[i].cells.length - 1; j < cells; j++) {
                if (!result.data[i]) {
                    result.data[i] = [];
                }
                result.data[i][j] = table.rows[i].cells[j].firstElementChild.value;
            }
        }
        result.data.shift();
        return result
    }

    // 比较两个数组的值是否相同
    function compare() {
        for (var i = 0; i < arguments.length; i++) {
            return arguments[i].toString() == arguments[i + 1].toString();
        }
    }

    // 判断数组中是否有指定的值
    function contains(arr, obj) {
        var i = arr.length;
        while (i--) {
            if (arr[i] === obj) {
                return true;
            }
        }
        return false;
    }

    function logout() {
        document.cookie = "remember=false";
        $.get('logout');
        window.location.href = 'login';
    }

    function setting() {
        window.location.href = "settings";
    }

</script>
</body>
</html>
