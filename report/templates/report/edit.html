<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Daily</title>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
</head>
<body>
<input type="button" id="statistics" onclick="statistics()" value="统计日报">
<input type="button" id="modify_today" onclick="modify_today()" value="修改今日已发">
<input type="button" id="search" onclick="search()" value="搜索">
<h4>前三天：</h4>
<style type="text/css">
    .AutoNewline {
        Word-break: break-all;
    }
</style>
<table class="AutoNewline" id="last" border="1">
    <tr>
        <th>项目</th>
        <th>工作类型</th>
        <th>Bug ID</th>
        <th>简要描述</th>
        <th>优先级</th>
        <th>是否reopen</th>
        <th>reopen原因</th>
        <th>解决方案</th>
        <th>原因</th>
        <th>责任人</th>
        <th>日期</th>
        <th>备注</th>
    </tr>
</table>
<br>
<h4>今日：</h4>
<table id="today" border="1" cellpadding="0" cellspacing="0">
    <tr>
        <th>项目</th>
        <th>工作类型</th>
        <th>Bug ID</th>
        <th>简要描述</th>
        <th>优先级</th>
        <th>是否reopen</th>
        <th>reopen原因</th>
        <th>解决方案</th>
        <th>原因</th>
        <th>责任人</th>
        <th>日期</th>
        <th>备注</th>
        <th></th>
    </tr>
    <tr id="content_0">
        <td>
            <input id="project" type="text">
        </td>
        <td>
            <select id="work_type">
                <option>解决bug</option>
                <option>非bug库问题处理</option>
                <option>基线升级</option>
                <option>需求分析实现</option>
                <option>团队建设</option>
                <option>项目支持</option>
                <option>SPM工作</option>
                <option>请假</option>
            </select>
        </td>
        <td>
            <input id="bugid" type="text">
        </td>
        <td>
            <textarea id="describe"></textarea>
        </td>
        <td>
            <select id="priority">
                <option></option>
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
            </select>
        </td>
        <td>
            <select id="reopen">
                <option></option>
                <option>是</option>
                <option>否</option>
            </select>
        </td>
        <td>
            <textarea id="reopen_reason"></textarea>
        </td>
        <td>
            <select id="solution">
                <option></option>
                <option>入库</option>
                <option>转其他组</option>
                <option>非问题</option>
                <option>是问题不修改</option>
                <option>重复</option>
                <option>不复现关闭</option>
                <option>输出文档</option>
            </select>
        </td>
        <td>
            <select id="solution_reason">
                <option></option>
                <option>原始问题</option>
                <option>转其他组</option>
                <option>修改引入</option>
                <option>新需求</option>
                <option>需求遗留问题</option>
                <option>非问题</option>
            </select>
        </td>
        <td>
            <input id="person" readonly="true"/>
        </td>
        <td>
            <input id="date" readonly="true"/>
        </td>
        <td>
            <textarea id="remake"></textarea>
        </td>
        <td>
            <input id="delete_item" type="button" value="delete"
                   onclick="delete_item(this.parentElement.parentElement.id)">
        </td>
    </tr>
</table>
<input id="insert" type="button" value="插入一行" onclick="insert()"><br>
<input id="submit" type="button" value="提交" onclick="submit_info()">
{#<script src="../../static/report/edit.js"></script>#}
<script>
    console.log(document.cookie);
    var i = 1;
    var data_old = [];
    var info_id = [];
    var user = document.cookie.match(/(^| )user=([^;]*)(;|$)/)[2].replace('"', '').replace('"', '');
    $.get('get_last_info', {"user": user}, function (ret) {
        if (ret != 0) {
            show_last(ret);
        }
    });

    $.get('get_current_name', {"user": user}, function (ret) {
        console.log(ret);
        document.getElementById("person").value = ret["name"];
        var today = ret['today'];
        if (!ret["permission"]) {
            document.getElementById("statistics").style.display = "none";
        } else if (today != "") {
            show_today(document.getElementById('content_0').children, today[0]);
            info_id.push(today[0]['id']);
            for (var j = 1; j < today.length; j++) {
                info_id.push(today[j]['id']);
                insert();
                show_today(document.getElementById('content_' + j.toString()).children, today[j]);
            }
            var mytable = document.getElementById("today");
            for (var i = 1, rows = mytable.rows.length; i < rows; i++) {
                for (var z = 0, cells = mytable.rows[i].cells.length; z < cells; z++) {
                    if (!data_old[i]) {
                        data_old[i] = [];
                    }
                    data_old[i][z] = mytable.rows[i].cells[z].firstElementChild.value;
                }
            }
        }
    });

    document.getElementById("date").value = getNowFormatDate();

    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        return year + seperator1 + month + seperator1 + strDate;
    }

    function show_today(ch, today) {
        ch[0].childNodes[1].value = today['project'];
        ch[1].childNodes[1].value = today['work_type'];
        ch[2].childNodes[1].value = today['bugid'];
        ch[3].childNodes[1].value = today['describe'];
        ch[4].childNodes[1].value = today['priority'];
        ch[5].childNodes[1].value = today['reopen'];
        ch[6].childNodes[1].value = today['reopen_reason'];
        ch[7].childNodes[1].value = today['solution'];
        ch[8].childNodes[1].value = today['solution_reason'];
        ch[9].childNodes[1].value = today['person'];
        ch[10].childNodes[1].value = today['date'];
        ch[11].childNodes[1].value = today['remake'];
    }

    function show_last(ret) {
        var last = document.getElementById("last");
        var today = document.getElementById("today");
        for (var i = 0; i < ret.length; i++) {
            var line = document.createElement("tr");
            var cell_project = document.createElement("td");
            var cell_work_type = document.createElement("td");
            var cell_bugid = document.createElement("td");
            var cell_describe = document.createElement("td");
            var cell_priority = document.createElement("td");
            var cell_reopen = document.createElement("td");
            var cell_reopen_reason = document.createElement("td");
            var cell_solution = document.createElement("td");
            var cell_solution_reason = document.createElement("td");
            var cell_person = document.createElement("td");
            var cell_date = document.createElement("td");
            var cell_remake = document.createElement("td");
            cell_project.innerText = ret[i].project;
            cell_work_type.innerText = ret[i].work_type;
            cell_bugid.innerText = ret[i].bugid;
            cell_describe.innerText = ret[i].describe;
            cell_priority.innerText = ret[i].priority;
            cell_reopen.innerText = ret[i].reopen;
            cell_reopen_reason.innerText = ret[i].reopen_reason;
            cell_solution.innerText = ret[i].solution;
            cell_solution_reason.innerText = ret[i].solution_reason;
            cell_person.innerText = ret[i].person;
            cell_date.innerText = ret[i].date;
            cell_remake.innerText = ret[i].remake;
            line.appendChild(cell_project);
            line.appendChild(cell_work_type);
            line.appendChild(cell_bugid);
            line.appendChild(cell_describe);
            line.appendChild(cell_priority);
            line.appendChild(cell_reopen);
            line.appendChild(cell_reopen_reason);
            line.appendChild(cell_solution);
            line.appendChild(cell_solution_reason);
            line.appendChild(cell_person);
            line.appendChild(cell_date);
            line.appendChild(cell_remake);
            last.appendChild(line);
        }
    }

    function insert() {
        var new_node = document.getElementById("content_0").cloneNode(true);
        new_node.id = "content_" + i.toString();
        today.appendChild(new_node);
        i++;
    }

    function submit_info() {
        var mytable = document.getElementById("today");
        var data_new = [];
        var data = [];
        var modify_id = [];
        var modify_data = [];
        for (var i = 1, rows = mytable.rows.length; i < rows; i++) {
            for (var j = 0, cells = mytable.rows[i].cells.length; j < cells; j++) {
                if (!data_new[i]) {
                    data_new[i] = [];
                }
                data_new[i][j] = mytable.rows[i].cells[j].firstElementChild.value;
            }
        }
        if (data_old.length === 0) {
            data = data_new.slice(1);
        } else if (data_old.length === data_new.length){
            for (var z = 0; z < info_id.length; z++) {
                if (!compare(data_old[z + 1], data_new[z + 1])) {
                    modify_id.push(info_id[z]);
                    modify_data.push(data_new[z + 1]);
                }
            }
        } else if (data_old.length < data_new.length) {
            data.push(data_new.slice(data_old.length));
        } else if (data_old.length > data_new.length) {

        }
        if (data_old.length !== 0 && modify_id.length === 0) {
            alert("内容无修改，提交失败! ");
            return
        }

        $.post("post_daily", {
                    "user": user,
                    "data": JSON.stringify(data),
                    "modify_id": JSON.stringify(modify_id),
                    "modify_data": JSON.stringify(modify_data)
                },
                function (ret) {
                    console.log(ret);
                    if (Number(ret) === 0) {
                        alert("提交成功！")
                    } else {
                        alert("提交失败！")
                    }
                });
    }

    function statistics() {
        window.location.href = "statistics";
    }

    function search() {
        window.location.href = "search";
    }

    function delete_item(id) {
        var self = document.getElementById(id);
        var parent = self.parentElement;
        parent.removeChild(self);
    }

    function modify_today() {
        window.location.href = "today";
    }

    function compare() {
        for (var i = 0; i < arguments.length; i++) {
            return arguments[i].toString() == arguments[i + 1].toString();
        }
    }

</script>
</body>
</html>