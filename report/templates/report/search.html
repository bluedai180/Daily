<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
</head>
<body>
<h1>搜索</h1>
工作类型: <select id="work_type">
    <option></option>
    <option>解决bug</option>
    <option>非bug库问题处理</option>
    <option>基线升级</option>
    <option>需求分析实现</option>
    <option>团队建设</option>
    <option>项目支持</option>
    <option>SPM工作</option>
    <option>请假</option>
</select><br>
Bug ID: <input id="search_bugid" type="text"><br>
简要描述: <input id="search_describe" type="text"><br>
解决方案: <select id="solution">
    <option></option>
    <option>入库</option>
    <option>转其他组</option>
    <option>非问题</option>
    <option>是问题不修改</option>
    <option>重复</option>
    <option>不复现关闭</option>
    <option>输出文档</option>
</select><br>
原因: <select id="solution_reason">
    <option></option>
    <option>原始问题</option>
    <option>转其他组</option>
    <option>修改引入</option>
    <option>新需求</option>
    <option>需求遗留问题</option>
    <option>非问题</option>
</select><br>
起始日期: <input id="start_date" type="date"><br>
结束日期: <input id="end_date" type="date"><br>
责任人: <input id="user" type="email">(空白默认全组成员)<br><br>
<input id="search" type="button" value="查询" onclick="search()">
<style type="text/css">
    .AutoNewline {
        Word-break: break-all;
    }
</style>
<div id="result_div" style="display: none">
    <h3>搜索结果：</h3>
    <table class="AutoNewline" id="result" border="1" cellpadding="5" cellspacing="0">
        <tr>
            <th>项目</th>
            <th>工作类型</th>
            <th>Bug ID</th>
            <th>简要描述</th>
            <th>优先级</th>
            <th>是否reopen</th>
            <th>reopen原因</th>
            <th>解决方案</th>
            <th>原因</th>
            <th>责任人</th>
            <th>日期</th>
            <th>备注</th>
        </tr>
    </table>
    <br>
    <input type="button" onclick="last_page()" value="上一页" id="last_page">
    <a id="pages_lable"></a>
    <input type="button" onclick="next_page()" value="下一页" id="next_page"><br><br>
    <input onclick="download()" value="导出Excel文件" type="button"><br>
</div>

<p id="none_result" style="display: none">查询无结果!</p>
{#<script src="../../static/report/search.js"></script>#}
<script>
    var team = document.cookie.match(/(^| )team=([^;]*)(;|$)/)[2];
    var result = document.getElementById("result");
    var last_page_btn = document.getElementById("last_page");
    var next_page_btn = document.getElementById("next_page");
    var pages_lable = document.getElementById("pages_lable");

    var total_pages = 0;
    var current_page = 1;

    for (let i = 0; i < 3; i++) {
        var line = document.createElement('tr');
        line.id = "line_" + i.toString();
        for (let j = 0; j < 12; j++) {
            line.appendChild(document.createElement('td'));
        }
        result.appendChild(line)
    }


    function search() {
        var work_type = document.getElementById("work_type").value;
        var search_bugid = document.getElementById("search_bugid").value;
        var search_describe = document.getElementById("search_describe").value;
        var solution = document.getElementById("solution").value;
        var solution_reason = document.getElementById("solution_reason").value;
        var start_date = document.getElementById("start_date").value;
        var end_date = document.getElementById("end_date").value;
        var user = document.getElementById("user").value;

        if ("" === work_type
                && "" === search_bugid
                && "" === search_describe
                && "" === solution
                && "" === solution_reason
                && "" === start_date
                && "" === end_date
                && "" === user) {
            alert("搜索内容不能为空！");
            return
        }

        if (("" === start_date && "" !== end_date) || ("" === end_date && "" !== start_date)) {
            alert("起始、终止日期要填全！");
            return
        }

        var info = {
            team: team,
            worktype: work_type,
            bugid: search_bugid,
            describe: search_describe,
            solution: solution,
            solution_reason: solution_reason,
            start_date: start_date,
            end_date: end_date,
            user: user
        };
        $.get('search_info', {"data": JSON.stringify(info)}, function (ret) {
            if (ret != 0) {
                total_pages = ret.pages;
                last_page_btn.disabled = true;
                if (total_pages === 1) {
                    next_page_btn.disabled = true;
                }
                pages_lable.innerText = "第" + current_page + "页，共" + total_pages + "页"
                show_result(ret.data);
                document.getElementById("result_div").style.display = "";
                document.getElementById("none_result").style.display = "none";
            } else {
                document.getElementById("none_result").style.display = "";
                document.getElementById("result_div").style.display = "none";
            }
        })
    }

    function show_result(ret) {

        var ret_length = ret.length;
        var table_length = 3;

        if (ret_length != table_length) {
            for (let i = 3 - ret_length; i > 0; i--) {
                document.getElementById("line_" + (3 - i)).style.display = 'none';
            }
        } else {
            for (let i = 0; i < table_length; i++) {
                document.getElementById("line_" + i).style.display = '';
            }
        }

        for (let i = 1; i < result.rows.length; i++) {
            for (let j = 0; j < result.rows[0].cells.length; j++) {
                result.rows[i].cells[j].innerText = "";
            }
        }

        for (let i = 0; i < ret.length; i++) {
            result.rows[i + 1].cells[0].innerText = ret[i].project;
            result.rows[i + 1].cells[1].innerText = ret[i].work_type;
            result.rows[i + 1].cells[2].innerText = ret[i].bugid;
            result.rows[i + 1].cells[3].innerText = ret[i].describe;
            result.rows[i + 1].cells[4].innerText = ret[i].reopen;
            result.rows[i + 1].cells[5].innerText = ret[i].reopen_reason;
            result.rows[i + 1].cells[6].innerText = ret[i].solution;
            result.rows[i + 1].cells[7].innerText = ret[i].solution_reason;
            result.rows[i + 1].cells[8].innerText = ret[i].person;
            result.rows[i + 1].cells[9].innerText = ret[i].date;
            result.rows[i + 1].cells[10].innerText = ret[i].remake;
        }
    }

    function last_page() {
        current_page -= 1;
        if (current_page < total_pages) {
            next_page_btn.disabled = false;
        }
        if (current_page === 1) {
            last_page_btn.disabled = true;
        }
        pages_lable.innerText = "第" + current_page + "页，共" + total_pages + "页"
        get_current_page();
    }

    function next_page() {
        current_page += 1;
        if (current_page > 1) {
            last_page_btn.disabled = false;
        }
        if (current_page === total_pages) {
            next_page_btn.disabled = true;
        }
        pages_lable.innerText = "第" + current_page + "页，共" + total_pages + "页"
        get_current_page();
    }

    function get_current_page() {
        $.get("move_page", {"page": current_page}, function (ret) {
            show_result(ret)
        })
    }

    function download() {
        window.location.href = "download_search"
    }
</script>
</body>
</html>